stages:
  - build
  - deploy

build app:
  stage: build
  image: docker:stable
  only:
    changes:
      - app/**/*
  services:
    - docker:dind
  variables:
    DOCKER_HOST: tcp://localhost:2375
    DOCKER_DRIVER: overlay2
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --cache-from $CI_REGISTRY_IMAGE --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME --tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA app
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_NAME
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA

deploy non-production:
  stage: deploy
  image: registry.promethist.ai/common/common/deployer
  only:
    - develop
    - preview
  script:
    - sed -i -- "s/chart.version/$CI_COMMIT_SHORT_SHA/g; s/app.version/$CI_COMMIT_REF_NAME/g" deploy/$CI_PROJECT_NAME/Chart.yaml
    - kctx ${K8S_DEFAULT_URL} ${K8S_DEFAULT_CERT} ${K8S_DEFAULT_TOKEN}
    - helm upgrade
      --install
      --recreate-pods
      --namespace $CI_COMMIT_REF_NAME
      --set namespace=$CI_COMMIT_REF_NAME
      --set git.ref=$CI_COMMIT_REF_NAME
      --set git.commit=$CI_COMMIT_SHORT_SHA
      --set app.image.tag=$CI_COMMIT_REF_NAME
      --set imagePullPolicy=Always
      $CI_PROJECT_NAME-$CI_COMMIT_REF_NAME
      deploy/$CI_PROJECT_NAME

deploy production:
  stage: deploy
  image: registry.promethist.ai/common/common/deployer
  only:
    - tags
  except:
    - /^(!master).+@/
  script:
    - sed -i -- "s/chart.version/$CI_COMMIT_REF_NAME/g; s/app.version/$CI_COMMIT_REF_NAME/g" deploy/$CI_PROJECT_NAME/Chart.yaml
    - kctx ${K8S_DEFAULT_URL} ${K8S_DEFAULT_CERT} ${K8S_DEFAULT_TOKEN}
    - helm upgrade
      --install
      --set git.ref=$CI_COMMIT_REF_NAME
      --set git.commit=$CI_COMMIT_SHORT_SHA
      --set app.image.tag=$CI_COMMIT_REF_NAME
      $CI_PROJECT_NAME
      deploy/$CI_PROJECT_NAME
