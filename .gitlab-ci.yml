stages:
  - deploy_packages
  - build
  - distribute
  - document

#
# JOB TEMPLATES
#
# .distribute
#
.distribute java client:
  stage: distribute
  image: registry.gitlab.com/promethist/system/builder
  variables:
    DIR: client/XXX
    NAME: NAME
  only:
    refs:
      - master
      - tags
  script:
    - cd $DIR
    - mvn -B package # maybe useless - should be already packaged by build job
    - cp target/$NAME.jar /ext/cluster/default/default/repository/dist/$NAME-$CI_COMMIT_REF_NAME.jar

#
# .build
#

.build snapshot:
  stage: build
  image: docker:stable
  variables:
    DIR: DIR
  only:
    refs:
      - master
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --force-rm --tag $CI_REGISTRY_IMAGE/$DIR --build-arg API_REF=$CI_COMMIT_SHORT_SHA --build-arg API_HOST=$CI_PROJECT_NAME.preview.promethist.com --build-arg VERSION=1.0.0-SNAPSHOT $DIR
    - docker push $CI_REGISTRY_IMAGE/$DIR

.build release:
  stage: build
  image: docker:stable
  variables:
    DIR: DIR
  only:
    refs:
      - tags
  except:
    - /^(!master).+@/
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --force-rm --cache-from $CI_REGISTRY_IMAGE/$DIR --tag $CI_REGISTRY_IMAGE/$DIR:$CI_COMMIT_REF_NAME --build-arg API_REF=$CI_COMMIT_REF_NAME --build-arg API_HOST=$CI_PROJECT_NAME.promethist.com --build-arg VERSION=$CI_COMMIT_REF_NAME $DIR
    - docker push $CI_REGISTRY_IMAGE/$DIR:$CI_COMMIT_REF_NAME

#
# .document
#
.document release:
  stage: document
  image: registry.gitlab.com/promethist/system/builder
  variables:
    DIR: api
    NAME: NAME
  only:
    refs:
      - tags
  except:
    - /^(!master).+@/
  script:
    - cd $DIR
    - mvn dokka:dokka
    - rsync -arv --delete ./target/dokka/$NAME /ext/cluster/default/default/site/default/apidoc/

.document snapshot:
  stage: document
  image: registry.gitlab.com/promethist/system/builder
  variables:
    DIR: api
    NAME: NAME
  only:
    refs:
      - master
  script:
    - cd $DIR
    - mvn dokka:dokka
    - rsync -arv --delete ./target/dokka/$NAME /ext/cluster/default/preview/site/default/apidoc/

#
# JOBS
#
# deploy all release packages
#
deploy release packages:
  stage: deploy_packages
  image: registry.gitlab.com/promethist/system/builder
  only:
    refs:
      - tags
  except:
    - /^(!master).+@/
  artifacts:
    untracked: true
  script:
    - mvn -B versions:set -DnewVersion=$CI_COMMIT_REF_NAME
    - mvn -B deploy -s settings.xml -DprivateKey=$DEPLOYER_KEY -Dapi.basedomain=promethist.com -Dmaven.wagon.http.pool=false -Dhttp.keepAlive=false

#
# deploy all snaphot packages
#
deploy snaphot packages:
  stage: deploy_packages
  image: registry.gitlab.com/promethist/system/builder
  only:
    refs:
      - master
  artifacts:
    untracked: true
  script:
    - mvn -B deploy -s settings.xml -DprivateKey=$DEPLOYER_KEY -Dapi.basedomain=preview.promethist.com -Dmaven.wagon.http.pool=false -Dhttp.keepAlive=false

#
# build docker images
#
build release runner/app:
  extends: '.build release'
  variables:
    DIR: runner/app
  only:
    changes:
      - runner/app/**/*

build snapshot runner/app:
  extends: '.build snapshot'
  variables:
    DIR: runner/app
  only:
    changes:
      - runner/app/**/*

build release builder/app:
  extends: '.build release'
  variables:
    DIR: builder/app
  only:
    changes:
      - builder/app/**/*

build snapshot builder/app:
  extends: '.build snapshot'
  variables:
    DIR: builder/app
  only:
    changes:
      - builder/app/**/*

#
# documents
#
document release lib:
  extends: '.document release'
  variables:
    DIR: lib
    NAME: promethist-core-lib

document snapshot lib:
  extends: '.document snapshot'
  variables:
    DIR: lib
    NAME: promethist-core-lib
  only:
    changes:
      - lib/**/*

document release app:
  extends: '.document release'
  variables:
    DIR: app
    NAME: promethist-core-app

document snapshot app:
  extends: '.document snapshot'
  variables:
    DIR: app
    NAME: promethist-core-app
  only:
    changes:
      - app/**/*

document release runner/api:
  extends: '.document release'
  variables:
    DIR: runner/api
    NAME: promethist-core-runner-api

document snapshot runner/api:
  extends: '.document snapshot'
  variables:
    DIR: runner/api
    NAME: promethist-core-runner-api
  only:
    changes:
      - runner/api/**/*

document release builder/api:
  extends: '.document release'
  variables:
    DIR: builder/api
    NAME: promethist-core-builder-api

document snapshot builder/api:
  extends: '.document snapshot'
  variables:
    DIR: builder/api
    NAME: promethist-core-builder-api
  only:
    changes:
      - builder/api/**/*

#
# distribute client/standalone
#
distribute client client/standalone:
  extends: '.distribute java client'
  variables:
    DIR: client/standalone
    NAME: promethist
  only:
    changes:
      - client/**/*
      - common/**/*