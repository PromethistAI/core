variables:
  REPO_DIR: /ext/cluster/default/default/repository

stages:
  - package
  - build
  - distribute
  - document

#
# JOB TEMPLATES
#
# .package
#
.package chart:
  stage: package
  image: registry.gitlab.com/promethistai/system/deployer
  variables:
    NAME: xxx
  only:
    refs:
      - tags
  script:
    - sed -i -- "s/chart.version/$CI_COMMIT_REF_NAME/g; s/app.version/$CI_COMMIT_REF_NAME/g" deploy/$NAME/Chart.yaml
    - helm3 package deploy/$NAME
    - cp *.tgz $REPO_DIR/helm

#
# .distribute
#
.distribute java client:
  stage: distribute
  image: registry.gitlab.com/promethistai/system/builder
  variables:
    DIR: client/XXX
    NAME: NAME
  only:
    refs:
      - master
      - tags
  script:
    - cd $DIR
    - mvn -B package # maybe useless - should be already packaged by build job
    - cp target/$NAME.jar $REPO_DIR/dist/$NAME-$CI_COMMIT_REF_NAME.jar

#
# .build
#

.build snapshot:
  stage: build
  image: docker:stable
  variables:
    DIR: DIR
  only:
    refs:
      - master
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --force-rm --tag $CI_REGISTRY_IMAGE/$DIR --build-arg API_REF=$CI_COMMIT_SHORT_SHA --build-arg API_HOST=$CI_PROJECT_NAME.preview.flowstorm.ai --build-arg VERSION=1.0.0-SNAPSHOT $DIR
    - docker push $CI_REGISTRY_IMAGE/$DIR

.build release:
  stage: build
  image: docker:stable
  variables:
    DIR: DIR
  only:
    refs:
      - tags
  except:
    - /^(!master).+@/
  services:
    - docker:dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --force-rm --cache-from $CI_REGISTRY_IMAGE/$DIR --tag $CI_REGISTRY_IMAGE/$DIR:$CI_COMMIT_REF_NAME --build-arg API_REF=$CI_COMMIT_REF_NAME --build-arg API_HOST=$CI_PROJECT_NAME.flowstorm.ai --build-arg VERSION=$CI_COMMIT_REF_NAME $DIR
    - docker push $CI_REGISTRY_IMAGE/$DIR:$CI_COMMIT_REF_NAME

#
# .document
#
.document release:
  stage: document
  image: registry.gitlab.com/promethistai/system/builder
  variables:
    DIR: api
    NAME: NAME
  only:
    refs:
      - tags
  except:
    - /^(!master).+@/
  script:
    - cd $DIR
    - mvn dokka:dokka
    - rsync -rv --delete ./target/dokka/$NAME /ext/cluster/default/default/site/default/apidoc/

.document snapshot:
  stage: document
  image: registry.gitlab.com/promethistai/system/builder
  variables:
    DIR: api
    NAME: NAME
  only:
    refs:
      - master
  script:
    - cd $DIR
    - mvn dokka:dokka
    - rsync -rv --delete ./target/dokka/$NAME /ext/cluster/default/preview/site/default/apidoc/

#
# JOBS
#
# package
#
package chart runner:
  extends: '.package chart'
  variables:
    NAME: runner
  only:
    changes:
      - deploy/runner/**/*

package chart builder:
  extends: '.package chart'
  variables:
    NAME: builder
  only:
    changes:
      - deploy/builder/**/*

package chart triton:
  extends: '.package chart'
  variables:
    NAME: triton
  only:
    changes:
      - deploy/triton/**/*

package release packages:
  stage: package
  image: registry.gitlab.com/promethistai/system/builder
  only:
    refs:
      - tags
  except:
    - /^(!master).+@/
  artifacts:
    untracked: true
  script:
    - mvn -B versions:set -DnewVersion=$CI_COMMIT_REF_NAME
    - mvn -B deploy -Dapi.basedomain=flowstorm.ai -Dmaven.wagon.http.pool=false -Dhttp.keepAlive=false

package snaphot packages:
  stage: package
  image: registry.gitlab.com/promethistai/system/builder
  only:
    refs:
      - master
  artifacts:
    untracked: true
  script:
    - mvn -B deploy -Dapi.basedomain=preview.flowstorm.ai -Dmaven.wagon.http.pool=false -Dhttp.keepAlive=false

#
# build
#
build release runner/app:
  extends: '.build release'
  variables:
    DIR: runner/app
  only:
    changes:
      - runner/app/**/*

build snapshot runner/app:
  extends: '.build snapshot'
  variables:
    DIR: runner/app
  only:
    changes:
      - runner/app/**/*

build release builder/app:
  extends: '.build release'
  variables:
    DIR: builder/app
  only:
    changes:
      - builder/app/**/*

build snapshot builder/app:
  extends: '.build snapshot'
  variables:
    DIR: builder/app
  only:
    changes:
      - builder/app/**/*

#
# distribute
#
distribute client client/standalone:
  extends: '.distribute java client'
  variables:
    DIR: client/standalone
    NAME: flowstorm
  only:
    changes:
      - client/**/*
      - common/**/*

distribute charts:
  stage: distribute
  image: registry.gitlab.com/promethistai/system/deployer
  only:
    refs:
      - tags
  script:
    - helm3 repo index $REPO_DIR/helm

#
# document
#
document release lib:
  extends: '.document release'
  variables:
    DIR: lib
    NAME: flowstorm-core-lib

document snapshot lib:
  extends: '.document snapshot'
  variables:
    DIR: lib
    NAME: flowstorm-core-lib
  only:
    changes:
      - lib/**/*

document release app:
  extends: '.document release'
  variables:
    DIR: app
    NAME: flowstorm-core-app

document snapshot app:
  extends: '.document snapshot'
  variables:
    DIR: app
    NAME: flowstorm-core-app
  only:
    changes:
      - app/**/*

document release runner/api:
  extends: '.document release'
  variables:
    DIR: runner/api
    NAME: flowstorm-core-runner-api

document snapshot runner/api:
  extends: '.document snapshot'
  variables:
    DIR: runner/api
    NAME: flowstorm-core-runner-api
  only:
    changes:
      - runner/api/**/*

document release builder/api:
  extends: '.document release'
  variables:
    DIR: builder/api
    NAME: flowstorm-core-builder-api

document snapshot builder/api:
  extends: '.document snapshot'
  variables:
    DIR: builder/api
    NAME: flowstorm-core-builder-api
  only:
    changes:
      - builder/api/**/*
